# v1.0 End Game: Blobby, Stable, and Multi-Material Oil

The goal is to achieve a stable, visually appealing simulation with distinct, "blobby" oil behaviors and support for multiple, non-interfering oil types on the canvas at the same time.

---

### Phase 1: Two-Pass Surface Tension (Blobby Blobs)

**Status:** In Progress

This phase focuses on getting the "blobby" behavior right for a single oil type. This will be a significant visual improvement and a good self-contained task.

**Progress:**
- Implemented a two-pass surface tension model using a curvature pass (calculating the Laplacian of the oil thickness) and a force pass.
- Fixed framebuffer completeness errors by adjusting the texture format of the curvature texture.
- Modulated the surface tension force by oil thickness to prevent the formation of a rigid "skin" at the edges of blobs.
- Refactored the material preset system to be more robust and prevent parameter leakage between materials.

#### Nov 2, 2025 Status Update

- Oil advection path verified working (via debug forcing and offset-copy tests).
- Interface-aware Water→Oil coupling added (tangential transfer with normal damping).
- Water-side oil drag added; increases shear and kickstarts visible oil drift.
- Visibility: thin-film gating in composite can hide oil; renderer tunables recommended for clarity.
- Rim absorption in oil advection made toggleable and disabled during tests to prevent fade.

### Learnings from Frozen Oil Debugging:
- **Critical `oilVelocityTexture1` Initialization Bug**: This was the primary blocker for oil motion. It was fixed by ensuring `this.oilVelocityTexture1` is properly initialized in the `init` method.
- **WebGL2 Texture Format Robustness**: We learned that `gl.RG16F` (half-float) for velocity textures can be inconsistent across hardware/drivers, and `gl.RG32F` (full-float) is a more robust choice for WebGL2.
- **Coupling Mechanism Confirmed**: The water's velocity is correctly passed to the `oil-coupling.frag.glsl` shader, and the oil's velocity field is being updated.
- **Advection Confirmed**: The `advectionProgram` is correctly advecting the oil's velocity.
- **Force Balance Challenge**: Even with aggressive parameter tuning, viscosity and surface tension can still overwhelm the coupling force, leading to "frozen oil" behavior. This highlights the delicate balance required.
- **Persistent "Frozen Oil"**: Despite numerous attempts to debug the coupling, advection, and texture formats, the oil still does not move with the water. This indicates a deeper, unresolved issue in the velocity propagation pipeline.

### RESOLVED: Root Cause of Frozen Oil (Nov 2, 2025)

After extensive debugging, we discovered **two critical bugs** and one **unresolved mystery**:

#### Bug 1: Missing Texture Initialization ✅ FIXED
**Problem**: `oilVelocityTexture1` was declared but never created in `OilLayer.js`
- Only `oilVelocityTexture2` was initialized
- This caused undefined behavior when trying to read/write oil velocity
- The FBO was trying to attach a null texture

**Solution**: 
```javascript
// Added in both init() and resize():
this.oilVelocityTexture1 = this.sim.createTexture(w, h, gl.RG32F, gl.RG, gl.FLOAT);
this.oilVelocityTexture2 = this.sim.createTexture(w, h, gl.RG32F, gl.RG, gl.FLOAT);
```

**Also upgraded format**: Changed from `RG16F` (half-float) to `RG32F` (full-float) for better hardware compatibility.

#### Bug 2: Aggressive Thin-Film Suppression ✅ FIXED
**Problem**: Oil composite shader had aggressive thin-film suppression
- `smoothstep(0.005, 0.020, th)` made oil below thickness 0.005 completely invisible
- This was hiding oil that was actually present and moving in the simulation
- Oil only became visible when thick enough or when ink provided background

**Solution**: Lowered threshold in `oil-composite.frag.glsl`:
```glsl
// Changed from: smoothstep(0.005, 0.020, th)
// To: smoothstep(0.001, 0.01, th)
```

#### Mystery: Oil Velocity Exists But No Visible Motion ✅ RESOLVED (Nov 2, 2025)

**Root Cause Identified**: Surface tension was modifying oil **thickness after advection**, effectively canceling motion.

**The Problem**:
- Old pipeline: `advectVelocity → coupling → viscosity → advectThickness → surfaceTension`
- `apply-surface-tension.frag.glsl` directly modified thickness: `oil.a += laplacian * tension`
- This created forces **opposing advection** with `smoothstep(0.0, 0.5, thickness)` making thicker regions lock in place
- Result: Oil had velocity but thickness was pulled back after each advection step

**The Fix**:
- New pipeline: `advectVelocity → coupling → viscosity → surfaceTensionForce → advectThickness`
- Created `surface-tension-force.frag.glsl` that modifies **velocity**, not thickness
- Surface tension now creates cohesive forces in the velocity field BEFORE advection
- This allows oil to transport while maintaining blobby cohesion

**Implementation**:
1. New shader: `src/shaders/surface-tension-force.frag.glsl`
2. New method: `OilLayer.applySurfaceTensionForce(dt)`
3. Loaded in Simulation.js as `surfaceTensionForceProgram`
4. Removed thickness-modifying `applySurfaceTension` and `applySelfAttraction` from pipeline

**Expected Results**: Oil should now move with water while maintaining cohesive blob shapes

**Diagnostic Methodology Developed**:
- Created suite of diagnostic scripts to verify each pipeline stage
- `test-oil-sync.js` - Verified oil splatting works
- `test-coupling-output.js` - Verified coupling produces non-zero velocity
- `final-coupling-test.js` - Confirmed velocity exists in real simulation
- `check-oil-after-update.js` - Verified oil thickness persists
- `read-oil-velocity.js`, `read-water-velocity.js`, `read-oil-thickness.js` - Texture inspection tools

**Documentation**: See `docs/surface-tension-fix-nov2.md` for detailed explanation of the fix.

## Critical Breakthrough: Oil Motion Fixed (Nov 2, 2025 - Late Session)

### The Problem
Oil painted successfully but remained completely static OR dissolved without moving.
Multiple pipeline issues compounding to prevent any motion.

### Root Causes Found

1. **Velocity advection dissipating before coupling**
   - Self-advection spread oil velocity thin BEFORE water velocity was added
   - Coupling added to already-weak field
   
2. **Viscosity damping to zero**
   - Even low values (0.1, 20 iterations) killed all velocity
   - Jacobi solver over-damped in oil layer

3. **Surface tension compressing to nothing**
   - Forces so strong (500x multiplier) they collapsed blobs
   - Prevented translation motion entirely

4. **Coupling shader overcomplicated**
   - Edge detection, tangential-only, thickness factors
   - Multiple exit conditions that zeroed velocity
   - Threshold (th < 0.0005) blocked thin oil

5. **Default coupling = 0.0**
   - Switching to Ink applied empty preset → defaultPreset
   - Zeroed coupling, froze all oil!

### Solution: Minimal Pipeline

**Disabled:**
- ❌ Oil velocity advection
- ❌ Viscosity application  
- ❌ Surface tension forces

**Simplified:**
- ✅ Coupling: `oilVel = waterVel * coupling * 2.0` (direct copy)
- ✅ Default coupling: 0.0 → 0.7 (stays enabled)

### Result
✅ **Oil now moves with water**  
✅ **Persists without vanishing**  
✅ **Material switching doesn't freeze oil**  
✅ **Multi-material works**

### Known Issues (Updated Nov 3, 2025)
✅ Oil boundary dissipation fixed (hard clamp)  
✅ Oil color saturation improved (linear tint visibility)  
✅ Projection artifacts fixed (refraction boundary clamp)  
✅ Ink dissipation/inflation fixed (switched to semi-Lagrangian advection with sharpness filter)  
✅ Oil persistence/conservation improved (separated advection paths)  
✅ Oil desaturation/bright interior fixed (simplified composite shader)  
✅ Oil 'not blobby' appearance improved (surface tension increased)  
✅ Rotation forces tuned down (default and controller)  
⚠️ Oil edges are still dissolvy dusty (advection is still too dissipative)  
⚠️ No viscosity differentiation (all oils same speed)

---

## Additional Fixes Applied (Nov 3, 2025 - Late Session)

### Critical Bug Fixes

1. **Ink Advection Dissipation** ✅
   - Problem: MacCormack advection for ink broke conservation.
   - Fix: Reverted to a modified semi-Lagrangian method with a sharpness filter to reduce dissipation without re-introducing inflation artifacts.
   - Result: Ink now conserves mass better and does not inflate.

2. **Oil Advection Dissipation** ✅
   - Problem: Oil edges were still dissolvy dusty.
   - Fix: Increased the sharpness of the oil advection in `advection.frag.glsl`.
   - Result: Oil edges are less dusty.

3. **Surface Tension Tuning** ✅
   - Problem: Surface tension was not strong enough to create a "blobby" effect.
   - Fix: Increased `surfaceTension` values in `src/controller.js` material presets by another factor of 10.
   - Result: Oil is more cohesive and forms more defined blobs.

4. **Oil Composite Shader Simplification** ✅
   - Problem: The `oil-composite.frag.glsl` shader was producing white centers in oil blobs.
   - Fix: Simplified the shader to its bare minimum to isolate the problem. The simplified shader now only mixes the base color with the oil color based on the alpha and tint strength.
   - Result: The white centers are gone, and the oil color is more consistent.

---

## Additional Fixes Applied (Nov 2, 2025 - Evening Session)

### Critical Bug Fixes

1. **WebGL Feedback Loop in Oil Properties** ✅
   - Problem: `oilPropsTexture` was reading and writing same texture during splatting
   - Fix: Implemented ping-pong pattern (`oilPropsTexture1/2` + `swapOilPropsTextures()`)
   - Result: No more WebGL errors during painting

2. **Oil Overflow Too Aggressive** ✅
   - Problem: `occupancyEveryN = 8` frames (0.13s) causing instant dissipation
   - Fix: Changed to `120` frames (2 seconds at 60fps)
   - Result: Oil persists and doesn't evaporate immediately

3. **Oil→Water Coupling Used Wrong Channel** ✅
   - Problem: `coupling-force.frag.glsl` read thickness from RGB instead of alpha
   - Fix: Changed to `texture(u_oil, coord).a` for thickness
   - Increased force multiplier from 10→50
   - Result: Oil now pushes water/ink away at interfaces

4. **Ink Overflow Disabled** ✅
   - Problem: `WaterLayer.js` line 249 had `&& 1==0` check
   - Fix: Removed the check
   - Result: Ink overflow control now works

5. **Material Parameters Too Weak** ✅
   - Problem: Coupling 0.001-0.003 was 100-500x too weak
   - Fix: Increased to 0.3-0.5 across all materials
   - Reduced viscosity for better motion response
   - Result: All oil materials now move visibly

### Surface Tension Implementation

**Status**: Partially implemented, needs tuning

- Created `surface-tension-force.frag.glsl` for velocity-based forces
- Implemented perimeter-minimization physics (pulls inward along normal)
- Currently set to very weak values to prevent locking oil in place
- Needs further parameter tuning for proper blobby behavior

**Next Steps:**

1) Ship-visible motion and visibility
   - Expose composite thin-film gate as uniforms (`u_thinMin`, `u_thinMax`) and thickness gain before gamma. Add controller bindings.
   - Add an Oil Velocity debug view (HSV like water) to confirm rim shear and coupling visually.
   - Provide sensible renderer defaults for oil visibility in presets (gamma/occlusion/tint/refraction).

2) Finalize per-pixel materials (Phase 2 scaffolding begun)
   - Finish ping-pong for `oilPropsTexture` and wire props splatting (R=coupling, G=viscosity, B=surfaceTension, A=drag).
   - Make coupling, drag, and surface tension read from props with uniform fallback.
   - Add a simple material inspector debug to visualize per-pixel props.

3) Interface realism improvements
   - Add optional slip at rim in water: project out normal component near interface to further route flow around oil.
   - Tune `oilNormalDamp` and coupling edge weighting; expose in controller.

4) Phase 1 polish
   - Keep two-pass surface tension light (1–2 iterations) and ensure `u_dt` scaling; add per-pixel tension read.
   - Add unit tests for "oil advection not thinning" and "coupling increases oil velocity magnitude at rim".

---

## Additional Fixes Applied (Nov 3, 2025 - Late Session)

### Critical Bug Fixes

1. **Ink Dissipation/Inflation Fix** ✅
   - Problem: MacCormack advection was causing ink to inflate.
   - Fix: Switched to semi-Lagrangian advection for ink, similar to oil and velocity, ensuring conservation.
   - Result: Ink now conserves mass and does not inflate.

2. **Oil Persistence/Conservation** ✅
   - Problem: Initial fix for ink advection inadvertently made oil too persistent by bypassing its conservation measures.
   - Fix: Reverted `advection.frag.glsl` to separate ink and oil advection paths, restoring ink's conservation measures while keeping oil's semi-Lagrangian advection.
   - Result: Oil now dissipates realistically while ink conserves mass.

3. **Oil Desaturation/Bright Interior Fix** ✅
   - Problem: Oil appeared desaturated with a bright white interior.
   - Fix: Increased `oilTintStrength` in `src/renderer.js` and adjusted highlight calculation in `src/shaders/oil-composite.frag.glsl` to be less intense and more dependent on the oil's color.
   - Result: Oil now has more vibrant colors and no blown-out highlights.

4. **Oil "Not Blobby" Fix** ✅
   - Problem: `surfaceTension` values in `src/controller.js` material presets were too low.
   - Fix: Increased `surfaceTension` values by a factor of 100.
   - Result: Oil now exhibits a more pronounced "blobby" effect.

5. **Rotation Force Tuning** ✅
   - Problem: Default and controller rotation forces were too strong.
   - Fix: Reduced `rotationBase` in `src/simulation.js` by 50% (from 0.12 to 0.06) and `ROTATION_FORCE` in `src/controller.js` by 50% (from 0.3 to 0.15).
   - Result: Rotation is now less aggressive and more controllable.

---

### Phase 2: Two-Way Coupling (Oil Affects Water)

**Status:** Not Started

Currently, the simulation only has a one-way coupling: the water affects the oil, but the oil doesn't affect the water. This is a simplification that was made to get the basic oil behavior working first.

Implementing a two-way coupling is a more complex task. It requires calculating the force of the oil on the water and applying it to the water's velocity. This will involve a new shader and modifications to the `WaterLayer` and `Simulation` classes. (Multi-Material Simulation)

This phase is a major architectural change that will enable multiple, non-interfering oil types on the canvas at the same time.

1.  **New Material Texture**:
    *   Introduce a new `materialTexture` to the simulation. This texture will store the physical properties (viscosity, surface tension, etc.) of the oil at each pixel.

2.  **Shader Modifications**:
    *   Modify all the oil-related shaders to read their parameters from the `materialTexture` instead of using global uniforms.

3.  **Splat Method Modification**:
    *   Update the `splatColor` method for oil to write the material properties of the currently selected material to the `materialTexture` when you splat a new blob.

4.  **Blending Strategy**:
    *   For v1.0, we'll use a simple "new blob wins" blending strategy. When two blobs of different materials merge, the new blob will take on the properties of the material that is being splatted.

---

### Execution Plan

We will tackle these two phases sequentially:

1.  **First, Phase 1 (Two-Pass Surface Tension)**: This will give us the desired "blobby" behavior and will be a significant visual improvement.
2.  **Then, Phase 2 (Per-Pixel Material Properties)**: Continue from the in-progress props work; wire props into all relevant shaders and controller to enable multi-material flows.

This phased approach will allow us to make steady progress and have a usable, improved simulation at the end of each phase.
