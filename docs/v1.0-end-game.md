# v1.0 End Game: Blobby, Stable, and Multi-Material Oil

The goal is to achieve a stable, visually appealing simulation with distinct, "blobby" oil behaviors and support for multiple, non-interfering oil types on the canvas at the same time.

---

### Phase 1: Two-Pass Surface Tension (Blobby Blobs)

**Status:** In Progress

This phase focuses on getting the "blobby" behavior right for a single oil type. This will be a significant visual improvement and a good self-contained task.

**Progress:**
- Implemented a two-pass surface tension model using a curvature pass (calculating the Laplacian of the oil thickness) and a force pass.
- Fixed framebuffer completeness errors by adjusting the texture format of the curvature texture.
- Modulated the surface tension force by oil thickness to prevent the formation of a rigid "skin" at the edges of blobs.
- Refactored the material preset system to be more robust and prevent parameter leakage between materials.

### Learnings from Frozen Oil Debugging:
- **Critical `oilVelocityTexture1` Initialization Bug**: This was the primary blocker for oil motion. It was fixed by ensuring `this.oilVelocityTexture1` is properly initialized in the `init` method.
- **WebGL2 Texture Format Robustness**: We learned that `gl.RG16F` (half-float) for velocity textures can be inconsistent across hardware/drivers, and `gl.RG32F` (full-float) is a more robust choice for WebGL2.
- **Coupling Mechanism Confirmed**: The water's velocity is correctly passed to the `oil-coupling.frag.glsl` shader, and the oil's velocity field is being updated.
- **Advection Confirmed**: The `advectionProgram` is correctly advecting the oil's velocity.
- **Force Balance Challenge**: Even with aggressive parameter tuning, viscosity and surface tension can still overwhelm the coupling force, leading to "frozen oil" behavior. This highlights the delicate balance required.
- **Persistent "Frozen Oil"**: Despite numerous attempts to debug the coupling, advection, and texture formats, the oil still does not move with the water. This indicates a deeper, unresolved issue in the velocity propagation pipeline.

**Next Steps:**

**Frozen Oil Investigation:**
- The oil is currently frozen in place, even when the water around it is moving. This suggests that the coupling between the water and oil layers is too weak or broken.
- The `oil-coupling.frag.glsl` shader was recently modified to fix a bug in the thickness calculation. It's possible that this fix was incorrect or that there's another issue in the shader that is preventing the water's velocity from being transferred to the oil.
- The `couplingStrength` parameter may also need to be tuned, but the primary focus should be on ensuring the coupling shader is working correctly.

- Tune the surface tension and coupling parameters to achieve the desired "blobby" look and feel. The oil is currently frozen in place, so the forces are still not balanced correctly.

1.  **Curvature Pass**:
    *   Create a new `curvature.frag.glsl` shader that takes the oil thickness as input.
    *   This shader will accurately calculate the curvature of the oil's surface and store it in a new texture.

2.  **Surface Tension Force Pass**:
    *   Create a new `apply-surface-tension.frag.glsl` shader.
    *   This shader will use the curvature texture to apply a force to the oil, pushing it from areas of high curvature to areas of low curvature. This is what will create the "blobby" shapes.

3.  **Integration**:
    *   Integrate these two new shader passes into the `OilLayer.js` update cycle.
    *   Add a `surfaceTensionIterations` parameter to the material presets to control the smoothness of the blobs.

---

### Phase 2: Two-Way Coupling (Oil Affects Water)

**Status:** Not Started

Currently, the simulation only has a one-way coupling: the water affects the oil, but the oil doesn't affect the water. This is a simplification that was made to get the basic oil behavior working first.

Implementing a two-way coupling is a more complex task. It requires calculating the force of the oil on the water and applying it to the water's velocity. This will involve a new shader and modifications to the `WaterLayer` and `Simulation` classes. (Multi-Material Simulation)

This phase is a major architectural change that will enable multiple, non-interfering oil types on the canvas at the same time.

1.  **New Material Texture**:
    *   Introduce a new `materialTexture` to the simulation. This texture will store the physical properties (viscosity, surface tension, etc.) of the oil at each pixel.

2.  **Shader Modifications**:
    *   Modify all the oil-related shaders to read their parameters from the `materialTexture` instead of using global uniforms.

3.  **Splat Method Modification**:
    *   Update the `splatColor` method for oil to write the material properties of the currently selected material to the `materialTexture` when you splat a new blob.

4.  **Blending Strategy**:
    *   For v1.0, we'll use a simple "new blob wins" blending strategy. When two blobs of different materials merge, the new blob will take on the properties of the material that is being splatted.

---

### Execution Plan

We will tackle these two phases sequentially:

1.  **First, Phase 1 (Two-Pass Surface Tension)**: This will give us the desired "blobby" behavior and will be a significant visual improvement.
2.  **Then, Phase 2 (Per-Pixel Material Properties)**: This is a much larger and more disruptive change, but it will deliver the final, multi-material simulation.

This phased approach will allow us to make steady progress and have a usable, improved simulation at the end of each phase.
